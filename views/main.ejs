<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">


    <script type="text/javascript" src="/public/javascripts/function.js"></script>
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>

    <style>
        #nubbci_chart{
            width: 100%;
            height: 500px;
            border: 1px solid #000;
        }
    </style>

    <script>
        // 윤년 계산
        const leap_year = (y) => {
            if(y%4 == 0){
                if(y%400 != 0 && y%100 == 0){
                    return false
                }
                else{
                    return true
                }
            }
            else{
                return true
            }
        }

        // 날짜 변경 조정
        const date_set = (year, month, day) => {
            switch (month){
                case 1: case 3: case 5: case 7:
                case 8: case 10:
                    if(day > 31){
                        month++;
                        day = 1;
                    }
                    break;
                case 4: case 6: case 9: case 11:
                    if(day > 30){
                        month++;
                        day = 1;
                    }
                    break;
                case 12:
                    if(day > 31){
                        year++;
                        month = 1;
                        day = 1;
                    }
                    break;
                case 2:
                    if(leap_year(year)){ // 윤년
                        if(day > 29){
                            month++;
                            day = 1;
                        }
                    } else{
                        if(day > 28){
                            month++;
                            day = 1;
                        }
                    }
                    break;
                default:
                    break;
            }
            return [year, month, day];
        }
    </script>

    <script>
        const function_result = function(fun) {
            let Y = []      // 년
            let M = []      // 월
            let D = []      // 일
            let date = []

            let TF, OF, R   // 총마리수, 사료공급 설정, 기간

            let T = []      // 수온
            let W = []      // 개체중량 g
            let TGC = []    
            let FR = []     // 사료공급률 %
            let FV = []     // 총 사료공급량 kg
            let Wg = []     // 개체 증중량(전날대비) g
            let TWg = []    // 총 증중량(전날대비) kg
            let FCR = []    // 
            let Wgid = []
            let Wid = []

            let today = document.getElementsByName("today")[0].value;
            W[0] = parseFloat(document.getElementsByName("W_early")[0].value);
            TF = document.getElementsByName("TF")[0].value;
            OF = document.getElementsByName("OF")[0].value;
            

            if(fun === 'next'){
                document.getElementsByName("R")[0].value++
            } else if(fun == 'prev'){
                document.getElementsByName("R")[0].value--
            }
            R = document.getElementsByName("R")[0].value
            
            let content = document.getElementsByClassName("content")[0]


            let result = []


            result[0] = ['date', 'Wid']


            if(today != "" && TF != "" && OF != "" && R != ""){
                Y[0] = parseInt(today.split("-")[0]);
                M[0] = parseInt(today.split("-")[1]);
                D[0] = parseInt(today.split("-")[2]);


                for(let i=0; i<R; i++){
                    date = date_set(Y[i], M[i], D[i])
                    Y[i] = date[0]
                    M[i] = date[1]
                    D[i] = date[2]


                    if(i == 0){
                        Wg[i] = null
                        TWg[i] = null
                    } else {
                        W[i] = F_w(T[i-1], TGC[i-1], W[i-1])
                        Wg[i] = F_Wg(W[i], W[i-1])
                        TWg[i] = F_TWg(Wg[i], TF)
                    }

                    T[i] = F_T(M[i], R)             // temp (월간 수온)
                    TGC[i] = F_TGC(T[i], W[i])      // TGC

                    
                    FR[i] = F_FR(T[i], W[i])        // FR
                    FV[i] = F_FV(FR[i], W[i], TF)   // FV

                    if(i == 0){
                        FCR[i] = null
                        Wgid[i] = null
                        Wid[i] = null
                    } else {
                        FCR[i] = F_FCR(TF, Wg[i], FV[i])
                        Wgid[i] = F_Wgid(OF, FCR[i], TF)
                        if(i == 1){
                            Wid[i] = F_Wid(W[i-1], Wgid[i])
                        } else{
                            Wid[i] = F_Wid(Wid[i-1], Wgid[i])
                        }
                    }

                    console.log(Y[i], M[i], D[i], Wid[i]);

                    result[i+1] = [new Date(Y[i], M[i]-1, D[i]), Wid[i]]

                    Y[i+1] = Y[i]
                    M[i+1] = M[i]
                    D[i+1] = D[i] + 1
                }
            } else {
                alert("값을 입력해주세요")
            }

            
            console.log(result);

            return result;
        }
    </script>


    <script type="text/javascript">
        google.charts.load('current', {'packages':['corechart']});
        
        function drawChart(fun) {
            let growth = function_result(fun);
            var data = google.visualization.arrayToDataTable(growth);

            var options = {
                width: '100%',
                title: '개체 중증량 (FCR 적용)',
                hAxis: {
                    title: 'Year',
                    format: 'yyyy-MM-dd'
                },
            }

            var chart = new google.visualization.LineChart(document.getElementById('nubbci_chart'));

            chart.draw(data, options);
            window.addEventListener('resize', drawChart, false)
        }
    </script>


    <link rel="shortcut icon" href="#">
    <title>main page</title>

</head>
<body>
    <a href="/login/logout">로그아웃</a>
    TODAY Y, M, d <input type="date" name="today">
    <br><br>
    초기값 W <input type="number" name="W_early">
    총 마리 수 TF <input type="number" name="TF">
    <br><br>
    사료 공급 설정 OF <input type="number" name="OF">
    기간 R <input type="number" name="R">
    <br><br>
    <button onclick="drawChart()">실행</button>
    <button onclick="drawChart('prev')">이전</button>
    <button onclick="drawChart('next')">다음</button>

    <div class="content"></div>

    <div id="nubbci_chart"></div>

</body>
</html>

